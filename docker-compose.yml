version: '3.8'

services:
  # PostgreSQL Database
  postgres-large:
    image: postgres:15-alpine
    container_name: car_entities_postgres_large
    environment:
      POSTGRES_DB: car_entities
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    command: >
      postgres
      -c shared_buffers=1GB
      -c effective_cache_size=3GB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=8MB
      -c min_wal_size=512MB
      -c max_wal_size=2GB
      -c max_connections=100
      -c max_worker_processes=4
      -c max_parallel_workers_per_gather=2
      -c max_parallel_workers=4
      -c max_parallel_maintenance_workers=2
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c pg_stat_statements.max=10000
      -c log_min_duration_statement=1000
      -c wal_level=logical
      -c max_replication_slots=10
      -c max_wal_senders=10
    ports:
      - "5433:5432"  # Changed to 5433 to avoid conflict with int-test-postgres
    volumes:
      - postgres_data_large:/var/lib/postgresql/data
      - ./postgres/init-small.sql:/docker-entrypoint-initdb.d/init-small.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d car_entities"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - car_network
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # PostgreSQL Metrics Database
  postgres-metrics:
    image: postgres:15-alpine
    container_name: postgres_metrics
    environment:
      POSTGRES_DB: performance_metrics
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    ports:
      - "5433:5432"
    volumes:
      - postgres_data_metrics:/var/lib/postgresql/data
      - ./load-test/shared/migrations:/docker-entrypoint-initdb.d:ro
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=512MB
      -c max_connections=50
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d performance_metrics"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - car_network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  # Redpanda - Kafka-compatible message broker
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    command:
      - redpanda
      - start
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:29092
      - --pandaproxy-addr
      - internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr
      - internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr
      - internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr
      - redpanda:33145
      - --advertise-rpc-addr
      - redpanda:33145
      - --smp
      - '1'
      - --memory
      - '1G'
      - --mode dev-container
      - --default-log-level=info
    ports:
      - "29092:19092"  # External Kafka API (changed to avoid conflict)
      - "29644:9644"   # Admin API (changed to avoid conflict)
      - "28081:8081"   # Schema Registry (changed to avoid conflict)
      - "28082:8082"   # Pandaproxy (changed to avoid conflict)
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    networks:
      - car_network
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy'"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Redpanda Console - Web UI for topic management
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: redpanda-console
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      KAFKA_BROKERS: redpanda:9092
      KAFKA_SCHEMAREGISTRY_ENABLED: "true"
      KAFKA_SCHEMAREGISTRY_URLS: http://redpanda:8081
    ports:
      - "8084:8080"
    depends_on:
      redpanda:
        condition: service_healthy
    networks:
      - car_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Kafka Connect with Debezium PostgreSQL Connector
  kafka-connect:
    image: quay.io/debezium/connect:2.6
    container_name: kafka-connect
    ports:
      - "8085:8083"  # Changed to 8085 to avoid conflict
    environment:
      # Bootstrap servers
      BOOTSTRAP_SERVERS: redpanda:9092
      # Group ID
      GROUP_ID: connect-cluster
      # Config storage
      CONFIG_STORAGE_TOPIC: connect-config
      CONFIG_STORAGE_REPLICATION_FACTOR: 1
      # Offset storage
      OFFSET_STORAGE_TOPIC: connect-offsets
      OFFSET_STORAGE_REPLICATION_FACTOR: 1
      # Status storage
      STATUS_STORAGE_TOPIC: connect-status
      STATUS_STORAGE_REPLICATION_FACTOR: 1
      # Converters
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      INTERNAL_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      INTERNAL_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      INTERNAL_KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      INTERNAL_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      # REST API
      REST_PORT: 8083
      REST_ADVERTISED_HOST_NAME: kafka-connect
      # Plugin path (Debezium connectors are pre-installed)
      CONNECT_PLUGIN_PATH: /kafka/connect
      # Logging
      LOG4J_ROOT_LOGLEVEL: INFO
    depends_on:
      redpanda:
        condition: service_healthy
      postgres-large:
        condition: service_healthy
    networks:
      - car_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8083/connectors || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Producer API - Spring Boot REST
  producer-api-java-rest:
    build: ./producer-api-java-rest
    container_name: producer-api-java-rest
    ports:
      - "9081:8081"
    environment:
      SPRING_R2DBC_URL: r2dbc:postgresql://postgres-large:5432/car_entities
      SPRING_R2DBC_USERNAME: postgres
      SPRING_R2DBC_PASSWORD: password
      JAVA_OPTS: "-Xmx1536m -Xms768m -XX:MaxMetaspaceSize=256m"
    depends_on:
      postgres-large:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - car_network
    profiles:
      - producer-java-rest
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # Producer API - Java gRPC
  producer-api-java-grpc:
    build: ./producer-api-java-grpc
    container_name: producer-api-java-grpc
    ports:
      - "9090:9090"
    environment:
      SPRING_R2DBC_URL: r2dbc:postgresql://postgres-large:5432/car_entities
      SPRING_R2DBC_USERNAME: postgres
      SPRING_R2DBC_PASSWORD: password
      JAVA_OPTS: "-Xmx1536m -Xms768m -XX:MaxMetaspaceSize=256m"
    depends_on:
      postgres-large:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - car_network
    profiles:
      - producer-java-grpc
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # Producer API - Rust REST
  producer-api-rust-rest:
    build: ./producer-api-rust-rest
    container_name: producer-api-rust-rest
    ports:
      - "9082:8081"
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres-large:5432/car_entities
      SERVER_PORT: 8081
      RUST_LOG: info
    depends_on:
      postgres-large:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - car_network
    profiles:
      - producer-rust-rest
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # Producer API - Rust gRPC
  producer-api-rust-grpc:
    build: ./producer-api-rust-grpc
    container_name: producer-api-rust-grpc
    ports:
      - "9091:9090"
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres-large:5432/car_entities
      GRPC_SERVER_PORT: 9090
      RUST_LOG: info
    depends_on:
      postgres-large:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - car_network
    profiles:
      - producer-rust-grpc
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # Producer API - Go REST
  producer-api-go-rest:
    build: ./producer-api-go-rest
    container_name: producer-api-go-rest
    ports:
      - "9083:9083"
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres-large:5432/car_entities
      SERVER_PORT: 9083
      LOG_LEVEL: info
      METADATA_SERVICE_URL: ${METADATA_SERVICE_URL:-http://metadata-service-java:8080}
      METADATA_SERVICE_TIMEOUT: ${METADATA_SERVICE_TIMEOUT:-5s}
    depends_on:
      postgres-large:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - car_network
    profiles:
      - producer-go-rest
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # Producer API - Go gRPC
  producer-api-go-grpc:
    build: ./producer-api-go-grpc
    container_name: producer-api-go-grpc
    ports:
      - "9092:9092"
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres-large:5432/car_entities
      GRPC_SERVER_PORT: 9092
      LOG_LEVEL: info
    depends_on:
      postgres-large:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - car_network
    profiles:
      - producer-go-grpc
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # Metadata Service - Schema Validation (Java)
  metadata-service-java:
    build: ./metadata-service-java
    container_name: metadata-service-java
    ports:
      - "8081:8080"
    environment:
      GIT_REPOSITORY: ${GIT_REPOSITORY:-file:///app/data}
      GIT_BRANCH: ${GIT_BRANCH:-main}
      LOCAL_CACHE_DIR: /tmp/schema-cache
      SERVER_PORT: 8080
      DEFAULT_VERSION: ${DEFAULT_VERSION:-v1}
      STRICT_MODE: ${STRICT_MODE:-true}
      CONFLUENT_CLOUD_API_KEY: ${CONFLUENT_CLOUD_API_KEY:-}
      CONFLUENT_CLOUD_API_SECRET: ${CONFLUENT_CLOUD_API_SECRET:-}
      CONFLUENT_FLINK_COMPUTE_POOL_ID: ${CONFLUENT_FLINK_COMPUTE_POOL_ID:-}
      CONFLUENT_FLINK_API_ENDPOINT: ${CONFLUENT_FLINK_API_ENDPOINT:-}
      # Database configuration for local postgres
      DATABASE_URL: ${DATABASE_URL:-jdbc:postgresql://postgres-large:5432/car_entities}
      DATABASE_USERNAME: ${DATABASE_USERNAME:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-password}
    volumes:
      - ./data:/app/data:rw
    # For local testing: mount data directory and use file:// URL for git
    # Example: GIT_REPOSITORY=file:///app/data docker-compose up
    depends_on:
      postgres-large:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - car_network
    profiles:
      - metadata-service-java
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # k6 Throughput Test Runner
  k6-throughput:
    build:
      context: ./load-test/shared
      dockerfile: Dockerfile
    container_name: k6-throughput
    environment:
      - K6_OUT=json=/k6/results/k6-results.json
    volumes:
      - ./load-test/k6:/k6/scripts:ro
      - ./load-test/results:/k6/results
      - ./producer-api-java-grpc/src/main/proto:/k6/proto/java-grpc:ro
      - ./producer-api-rust-grpc/proto:/k6/proto/rust-grpc:ro
      - ./producer-api-go-grpc/proto:/k6/proto/go-grpc:ro
    networks:
      - car_network
    restart: "no"
    profiles:
      - k6-test
    # Increase ephemeral port range to handle high connection counts
    # This helps prevent "cannot assign requested address" errors with many VUs
    sysctls:
      - net.ipv4.ip_local_port_range=10000 65535
      - net.core.somaxconn=4096
      - net.ipv4.tcp_max_syn_backlog=4096
      - net.ipv4.tcp_tw_reuse=1
      - net.ipv4.tcp_fin_timeout=30
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    # Default command - will be overridden by docker-compose run
    command: ["/bin/sh", "-c", "echo 'k6 throughput test container ready. Use docker-compose run to execute tests.'"]

volumes:
  postgres_data_large:
  postgres_data_metrics:
  metadata_cache:
  redpanda-data:

networks:
  car_network:
    driver: bridge
