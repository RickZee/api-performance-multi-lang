version: '3.8'

# Docker Compose for CDC with Confluent Cloud
# This setup uses local Kafka Connect to bridge local Postgres to Confluent Cloud
#
# Prerequisites:
# 1. Main postgres running: docker-compose -f ../docker-compose.yml up -d postgres-large
# 2. Source the .env file: source .env
#
# Usage:
# docker-compose -f docker-compose.confluent-cloud.yml up -d

services:
  # Kafka Connect configured for Confluent Cloud
  kafka-connect-cloud:
    image: confluentinc/cp-kafka-connect:7.5.0
    container_name: cdc-kafka-connect-cloud
    hostname: kafka-connect-cloud
    ports:
      - "8083:8083"
    environment:
      # Confluent Cloud Kafka Configuration
      CONNECT_BOOTSTRAP_SERVERS: '${KAFKA_BOOTSTRAP_SERVERS:-pkc-oxqxx9.us-east-1.aws.confluent.cloud:9092}'
      CONNECT_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_SASL_MECHANISM: PLAIN
      CONNECT_SASL_JAAS_CONFIG: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="${KAFKA_API_KEY}" password="${KAFKA_API_SECRET}";'
      
      # Producer Configuration (for writing to Confluent Cloud)
      CONNECT_PRODUCER_BOOTSTRAP_SERVERS: '${KAFKA_BOOTSTRAP_SERVERS:-pkc-oxqxx9.us-east-1.aws.confluent.cloud:9092}'
      CONNECT_PRODUCER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_PRODUCER_SASL_MECHANISM: PLAIN
      CONNECT_PRODUCER_SASL_JAAS_CONFIG: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="${KAFKA_API_KEY}" password="${KAFKA_API_SECRET}";'
      
      # Consumer Configuration (for reading from Confluent Cloud)
      CONNECT_CONSUMER_BOOTSTRAP_SERVERS: '${KAFKA_BOOTSTRAP_SERVERS:-pkc-oxqxx9.us-east-1.aws.confluent.cloud:9092}'
      CONNECT_CONSUMER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_CONSUMER_SASL_MECHANISM: PLAIN
      CONNECT_CONSUMER_SASL_JAAS_CONFIG: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="${KAFKA_API_KEY}" password="${KAFKA_API_SECRET}";'
      
      # Connect Configuration
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect-cloud
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: confluent-cloud-connect-group
      
      # Topics Configuration (stored in Confluent Cloud)
      CONNECT_CONFIG_STORAGE_TOPIC: _connect-configs
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_FLUSH_INTERVAL_MS: 10000
      CONNECT_OFFSET_STORAGE_TOPIC: _connect-offsets
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_TOPIC: _connect-status
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
      
      # Converters (using Confluent Cloud Schema Registry)
      CONNECT_KEY_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: '${SCHEMA_REGISTRY_URL}'
      CONNECT_KEY_CONVERTER_BASIC_AUTH_CREDENTIALS_SOURCE: USER_INFO
      CONNECT_KEY_CONVERTER_BASIC_AUTH_USER_INFO: '${SCHEMA_REGISTRY_API_KEY}:${SCHEMA_REGISTRY_API_SECRET}'
      
      CONNECT_VALUE_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: '${SCHEMA_REGISTRY_URL}'
      CONNECT_VALUE_CONVERTER_BASIC_AUTH_CREDENTIALS_SOURCE: USER_INFO
      CONNECT_VALUE_CONVERTER_BASIC_AUTH_USER_INFO: '${SCHEMA_REGISTRY_API_KEY}:${SCHEMA_REGISTRY_API_SECRET}'
      
      # Plugin Path
      CONNECT_PLUGIN_PATH: "/usr/share/java,/usr/share/confluent-hub-components"
      CONNECT_LOG4J_LOGGERS: org.apache.zookeeper=ERROR,org.I0Itec.zkclient=ERROR,org.reflections=ERROR
      
    volumes:
      - ./connectors:/connectors
    networks:
      - car_network
    command:
      - bash
      - -c
      - |
        echo "Installing Connectors..."
        confluent-hub install --no-prompt debezium/debezium-connector-postgresql:2.4.0 || true
        echo "Starting Kafka Connect..."
        /etc/confluent/docker/run
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/connectors"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Loan Consumer (using Confluent Cloud)
  loan-consumer-cloud:
    build:
      context: ./consumers/loan-consumer
      dockerfile: Dockerfile
    container_name: cdc-loan-consumer-cloud
    hostname: loan-consumer-cloud
    environment:
      KAFKA_BOOTSTRAP_SERVERS: '${KAFKA_BOOTSTRAP_SERVERS:-pkc-oxqxx9.us-east-1.aws.confluent.cloud:9092}'
      KAFKA_SECURITY_PROTOCOL: SASL_SSL
      KAFKA_SASL_MECHANISM: PLAIN
      KAFKA_SASL_USERNAME: '${KAFKA_API_KEY}'
      KAFKA_SASL_PASSWORD: '${KAFKA_API_SECRET}'
      KAFKA_TOPIC: filtered-loan-events
      SCHEMA_REGISTRY_URL: '${SCHEMA_REGISTRY_URL}'
      SCHEMA_REGISTRY_API_KEY: '${SCHEMA_REGISTRY_API_KEY}'
      SCHEMA_REGISTRY_API_SECRET: '${SCHEMA_REGISTRY_API_SECRET}'
      CONSUMER_GROUP_ID: loan-consumer-cloud-group
    networks:
      - car_network
    restart: unless-stopped
    profiles:
      - consumers

  # Service Consumer (using Confluent Cloud)
  service-consumer-cloud:
    build:
      context: ./consumers/service-consumer
      dockerfile: Dockerfile
    container_name: cdc-service-consumer-cloud
    hostname: service-consumer-cloud
    environment:
      KAFKA_BOOTSTRAP_SERVERS: '${KAFKA_BOOTSTRAP_SERVERS:-pkc-oxqxx9.us-east-1.aws.confluent.cloud:9092}'
      KAFKA_SECURITY_PROTOCOL: SASL_SSL
      KAFKA_SASL_MECHANISM: PLAIN
      KAFKA_SASL_USERNAME: '${KAFKA_API_KEY}'
      KAFKA_SASL_PASSWORD: '${KAFKA_API_SECRET}'
      KAFKA_TOPIC: filtered-service-events
      SCHEMA_REGISTRY_URL: '${SCHEMA_REGISTRY_URL}'
      SCHEMA_REGISTRY_API_KEY: '${SCHEMA_REGISTRY_API_KEY}'
      SCHEMA_REGISTRY_API_SECRET: '${SCHEMA_REGISTRY_API_SECRET}'
      CONSUMER_GROUP_ID: service-consumer-cloud-group
    networks:
      - car_network
    restart: unless-stopped
    profiles:
      - consumers

networks:
  car_network:
    external: true





